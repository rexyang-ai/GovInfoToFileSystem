{% extends "base.html" %}

{% block content %}
<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
            <h2>规则库管理</h2>
            <p class="text-muted">管理爬虫采集规则</p>
        </div>
        <button class="btn" onclick="openRuleModal()">+ 新增规则</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="width: 50px;">ID</th>
                    <th style="width: 150px;">规则名称</th>
                    <th style="width: 150px;">域名</th>
                    <th>URL 示例/模式</th>
                    <th style="width: 150px;">创建时间</th>
                    <th style="width: 200px;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in rules %}
                <tr>
                    <td>{{ rule.id }}</td>
                    <td>{{ rule.rule_name }}</td>
                    <td>{{ rule.domain }}</td>
                    <td style="word-break: break-all;">{{ rule.url_pattern }}</td>
                    <td>{{ rule.created_at }}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editRule('{{ rule.id }}')">编辑</button>
                        <button class="btn btn-sm btn-warning" onclick="copyRule('{{ rule.id }}')">复制</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule('{{ rule.id }}')">删除</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center" style="padding: 2rem;">暂无规则</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Rule Modal -->
<div id="ruleModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <h3 id="modalTitle" style="margin-top: 0;">新增规则</h3>
        
        <input type="hidden" id="ruleId">
        
        <div class="form-group">
            <label>规则名称 <span class="text-danger">*</span></label>
            <input type="text" id="ruleName" class="form-control" placeholder="例如：某某政府网新闻列表">
        </div>
        
        <div class="form-group">
            <label>URL 示例/模式 <span class="text-danger">*</span></label>
            <input type="text" id="urlPattern" class="form-control" placeholder="https://example.com/news/...">
            <small class="text-muted">系统将自动从 URL 中提取域名</small>
        </div>
        
        <div class="row" style="display: flex; gap: 1rem;">
            <div class="form-group" style="flex: 1;">
                <label>标题 XPath</label>
                <input type="text" id="titleXpath" class="form-control">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>正文 XPath</label>
                <input type="text" id="contentXpath" class="form-control">
            </div>
        </div>
        
        <div class="form-group">
            <label>请求头 (支持 JSON 或 浏览器复制的原始文本)</label>
            <textarea id="requestHeaders" class="form-control" rows="5" placeholder='User-Agent: ...'></textarea>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button class="btn" onclick="saveRule()">保存</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openRuleModal(isEdit = false) {
        document.getElementById('modalTitle').innerText = isEdit ? '编辑规则' : '新增规则';
        document.getElementById('ruleModal').style.display = 'flex';
        if (!isEdit) {
            // Clear form
            document.getElementById('ruleId').value = '';
            document.getElementById('ruleName').value = '';
            document.getElementById('urlPattern').value = '';
            document.getElementById('titleXpath').value = '';
            document.getElementById('contentXpath').value = '';
            document.getElementById('requestHeaders').value = '';
        }
    }

    function closeModal() {
        document.getElementById('ruleModal').style.display = 'none';
    }

    function editRule(id) {
        fetch(`/rules/get/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                document.getElementById('ruleId').value = data.id;
                document.getElementById('ruleName').value = data.rule_name;
                document.getElementById('urlPattern').value = data.url_pattern;
                document.getElementById('titleXpath').value = data.title_xpath;
                document.getElementById('contentXpath').value = data.content_xpath;
                document.getElementById('requestHeaders').value = data.request_headers;
                
                openRuleModal(true);
            })
            .catch(err => alert('加载失败: ' + err));
    }

    function saveRule() {
        const id = document.getElementById('ruleId').value;
        const data = {
            rule_name: document.getElementById('ruleName').value,
            url_pattern: document.getElementById('urlPattern').value,
            title_xpath: document.getElementById('titleXpath').value,
            content_xpath: document.getElementById('contentXpath').value,
            request_headers: document.getElementById('requestHeaders').value
        };

        if (!data.rule_name || !data.url_pattern) {
            alert('规则名称和 URL 不能为空');
            return;
        }

        const url = id ? `/rules/update/${id}` : '/rules/add';
        
        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if (res.error) {
                alert('保存失败: ' + res.error);
            } else {
                alert('保存成功');
                location.reload();
            }
        })
        .catch(err => alert('请求错误: ' + err));
    }

    function deleteRule(id) {
        if (!confirm('确定要删除这条规则吗？')) return;
        
        fetch(`/rules/delete/${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(res => {
                if (res.error) {
                    alert('删除失败: ' + res.error);
                } else {
                    location.reload();
                }
            })
            .catch(err => alert('请求错误: ' + err));
    }

    function copyRule(id) {
        if (!confirm('确定要复制这条规则吗？')) return;
        
        fetch(`/rules/copy/${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(res => {
                if (res.error) {
                    alert('复制失败: ' + res.error);
                } else {
                    alert('复制成功');
                    location.reload();
                }
            })
            .catch(err => alert('请求错误: ' + err));
    }
</script>
{% endblock %}
