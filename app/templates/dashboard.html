{% extends "base.html" %}

{% block content %}
<!-- Toast 消息容器 -->
<div id="toast-container" class="toast-container"></div>

<style>
    .progress-container {
        height: 25px;
        background-color: #37474f;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        display: none;
        position: relative;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #81c784);
        width: 0%;
        transition: width 0.5s ease;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }
    .progress-text-overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        color: white;
        font-size: 0.85rem;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    /* 添加条纹动画 */
    .progress-bar {
        background-image: linear-gradient(
            45deg, 
            rgba(255, 255, 255, 0.15) 25%, 
            transparent 25%, 
            transparent 50%, 
            rgba(255, 255, 255, 0.15) 50%, 
            rgba(255, 255, 255, 0.15) 75%, 
            transparent 75%, 
            transparent
        );
        background-size: 1rem 1rem;
        animation: progress-bar-stripes 1s linear infinite;
    }
    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }
</style>

<div>
    <!-- 1. 栏目名称区 -->
    <div class="page-header">
        <div class="page-title">
            <h2>数据采集控制台</h2>
            <p>输入关键字启动智能爬虫，获取最新互联网数据</p>
        </div>
        <div class="page-actions">
            <!-- 预留操作区 -->
        </div>
    </div>

    <!-- 2. 搜索与设置区 -->
    <div class="section-filter" style="display: block;">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <input type="text" id="keyword" class="form-control" placeholder="请输入搜索关键字或需求..." style="flex: 1; font-size: 1.1rem;">
            <button id="btn-search" class="btn" style="padding-left: 2rem; padding-right: 2rem;">开始采集</button>
        </div>

        <!-- 分页设置 (默认隐藏) -->
        <div id="pagination-settings" style="display: none; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <span style="font-weight: bold; color: var(--secondary-color);">采集设置:</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="max-pages" style="margin: 0;">最大页数:</label>
                    <input type="number" id="max-pages" class="form-control" style="width: 80px;" value="5" min="1" max="100">
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="max-items" style="margin: 0;">最大数量:</label>
                    <input type="number" id="max-items" class="form-control" style="width: 100px;" value="100" min="1" max="1000">
                </div>
                <small class="text-muted" style="margin-left: auto;">(仅对支持分页的数据源生效)</small>
            </div>
        </div>

        <!-- 数据源选择 -->
        <div class="source-selection">
            <div style="margin-bottom: 10px; color: var(--secondary-color); font-size: 0.9rem;">选择数据源:</div>
            <div id="source-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                <!-- 数据源将由 JS 填充 -->
            </div>
        </div>
    </div>

    <!-- 进度条 -->
    <div id="search-progress" class="progress-container">
        <div class="progress-bar"></div>
        <div class="progress-text-overlay">准备就绪</div>
    </div>

    <!-- 3. 结果列表区 -->
    <div id="results-section" style="display: none;">
        <!-- 按钮功能区 -->
        <div class="section-toolbar">
            <h3 style="margin: 0; font-size: 1.2rem;">采集结果预览 (<span id="result-count">0</span>)</h3>
            <div style="margin-left: auto; display: flex; gap: 1rem;">
                <button id="btn-select-all" class="btn btn-secondary btn-sm">全选</button>
                <button id="btn-save" class="btn btn-sm">批量保存到仓库</button>
            </div>
        </div>
        
        <!-- 列表内容 -->
        <div class="section-list" style="padding: 1rem;">
            <div id="results-grid" class="results-grid">
                <!-- 结果将在此处插入 -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toast 提示函数
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <span>${message}</span>
            <span style="cursor:pointer; margin-left: 10px;" onclick="this.parentElement.remove()">&times;</span>
        `;
        container.appendChild(toast);

        // 3秒后自动移除
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    $(document).ready(function() {
        const defaultNoImage = "{{ url_for('static', filename='images/noimage.png') }}";
        let currentResults = [];
        let allSources = {};

        // 加载动态数据源
        $.get("{{ url_for('api_list_sources_full') }}", { per_page: 1000 }, function(response) {
            const container = $('#source-list');
            const data = response.items || [];
            if(data.length === 0) {
                container.html('<span class="text-muted">暂无可用数据源</span>');
                return;
            }
            data.forEach(function(source) {
                allSources[source.id] = source;
                const toggle = `
                    <label class="toggle-label">
                        <div class="toggle-switch">
                            <input type="checkbox" name="source" value="${source.id}">
                            <span class="slider"></span>
                        </div>
                        ${source.name}
                    </label>
                `;
                container.append(toggle);
            });
            updatePaginationVisibility();
        }).fail(function() {
            showToast('加载数据源失败', 'error');
        });

        $(document).on('change', 'input[name="source"]', function() {
            updatePaginationVisibility();
        });

        function updatePaginationVisibility() {
            let hasPagination = false;
            $('input[name="source"]:checked').each(function() {
                const id = $(this).val();
                const source = allSources[id];
                if (source && source.pagination_param) {
                    hasPagination = true;
                    return false;
                }
            });
            
            if (hasPagination) {
                $('#pagination-settings').slideDown();
            } else {
                $('#pagination-settings').slideUp();
            }
        }

        $('#btn-search').click(function() {
            const keyword = $('#keyword').val().trim();
            if (!keyword) {
                showToast('请输入关键字', 'error');
                return;
            }

            // 获取选中的数据源
            const selectedSources = [];
            $('input[name="source"]:checked').each(function() {
                selectedSources.push($(this).val());
            });

            if (selectedSources.length === 0) {
                showToast('请至少选择一个数据源', 'error');
                return;
            }

            // 获取分页配置
            const maxPages = parseInt($('#max-pages').val()) || 1;
            const maxItems = parseInt($('#max-items').val()) || 100;

            // 重置 UI
            $('#results-section').hide();
            $('#results-grid').empty();
            currentResults = [];
            
            const btn = $(this);
            const originalText = btn.text();
            btn.prop('disabled', true).text('采集进行中...');
            
            // 启动进度条
            $('#search-progress').show();
            $('.progress-bar').css('width', '0%');
            $('.progress-text-overlay').text('正在初始化...');
            
            showToast('开始采集...', 'info');

            $.ajax({
                url: "{{ url_for('search') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    keyword: keyword,
                    sources: selectedSources,
                    max_pages: maxPages,
                    max_items: maxItems
                }),
                success: function(response) {
                    const taskId = response.task_id;
                    pollStatus(taskId, btn, originalText, maxItems);
                },
                error: function(xhr) {
                    $('.progress-bar').css('background', '#ef4444');
                    setTimeout(() => $('#search-progress').fadeOut(), 1000);
                    btn.prop('disabled', false).text(originalText);
                    showToast('启动采集失败: ' + (xhr.responseJSON?.error || '未知错误'), 'error');
                }
            });
        });

        function pollStatus(taskId, btn, originalText, maxItems) {
            const interval = setInterval(() => {
                $.get(`/search/status/${taskId}`, function(statusData) {
                    // 更新进度
                    const currentCount = statusData.current_count || 0;
                    const percentage = Math.min((currentCount / maxItems) * 100, 95); // 上限 95%，直到完成
                    
                    $('.progress-bar').css('width', percentage + '%');
                    
                    // 更新条内文字
                    let progressText = statusData.progress || `已采集 ${currentCount} 条`;
                    let textContent = `${progressText} (${Math.round(percentage)}%)`;
                    $('.progress-text-overlay').text(textContent);

                    // --- 增量渲染开始 ---
                    const newResults = statusData.result || [];
                    if (newResults.length > currentResults.length) {
                        const startIdx = currentResults.length;
                        const itemsToAdd = newResults.slice(startIdx);
                        
                        // 渲染追加的项目
                        if ($('#results-section').is(':hidden')) {
                            $('#results-section').fadeIn();
                        }
                        
                        renderResults(itemsToAdd, true, startIdx);
                        currentResults = newResults; // 更新本地状态
                        
                        $('#result-count').text(currentResults.length);
                        
                        // 更新统计显示（如果存在）
                        if ($('#stats-display').length === 0) {
                            $('#results-section .section-toolbar h3').after(`<span id="stats-display" style="margin-left: 20px; font-size: 0.9rem; color: var(--secondary-color);">计划: ${maxItems} / 实际: ${currentResults.length}</span>`);
                        } else {
                            $('#stats-display').text(`计划: ${maxItems} / 实际: ${currentResults.length}`);
                        }
                    }
                    // --- 增量渲染结束 ---

                    if (statusData.status === 'completed') {
                        clearInterval(interval);
                        $('.progress-bar').css('width', '100%');
                        $('.progress-text-overlay').text('采集完成 (100%)');
                        setTimeout(() => $('#search-progress').fadeOut(), 2000);
                        
                        btn.prop('disabled', false).text(originalText);
                        
                        // 最终检查以确保所有内容都已渲染
                        if (statusData.result && statusData.result.length > currentResults.length) {
                             const startIdx = currentResults.length;
                             const itemsToAdd = statusData.result.slice(startIdx);
                             renderResults(itemsToAdd, true, startIdx);
                             currentResults = statusData.result;
                             $('#result-count').text(currentResults.length);
                             if ($('#stats-display').length > 0) {
                                $('#stats-display').text(`计划: ${maxItems} / 实际: ${currentResults.length}`);
                             }
                        }
                        
                        // 显示统计
                        showToast(`采集完成，计划 ${maxItems} 条，实际 ${currentResults.length} 条`, 'success');
                        
                        if (currentResults.length === 0) {
                            showToast('未找到相关数据', 'info');
                        }
                    } else if (statusData.status === 'failed') {
                        clearInterval(interval);
                        $('.progress-bar').css('background', '#ef4444');
                        $('.progress-text-overlay').text('采集失败');
                        btn.prop('disabled', false).text(originalText);
                        showToast('采集出错: ' + statusData.error, 'error');
                    }
                }).fail(function() {
                    clearInterval(interval);
                    btn.prop('disabled', false).text(originalText);
                    showToast('查询进度失败', 'error');
                });
            }, 1000);
        }

        function renderResults(results, append = false, startOffset = 0) {
            const grid = $('#results-grid');
            if (!append) grid.empty(); // 清除之前的
            results.forEach((item, index) => {
                const globalIndex = startOffset + index;
                const card = `
                    <div class="result-card" data-index="${globalIndex}">
                        <input type="checkbox" class="result-checkbox" checked>
                        <img src="${item.cover_url || defaultNoImage}" class="result-img" onerror="this.src='${defaultNoImage}'">
                        <div class="result-content">
                            <h3 class="result-title">
                                <a href="${item.url}" target="_blank">${item.title}</a>
                            </h3>
                            <div class="result-summary">${item.summary || '暂无摘要'}</div>
                            <div class="result-meta">
                                <span class="text-muted">来源: ${item.source || '互联网'}</span>
                                <span class="text-muted" style="margin-left: 10px;">${item.date || ''}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.append(card);
            });
        }

        $('#btn-select-all').click(function() {
            const checkboxes = $('.result-checkbox');
            const allChecked = checkboxes.length === checkboxes.filter(':checked').length;
            checkboxes.prop('checked', !allChecked);
        });

        $('#btn-save').click(function() {
            const selectedIndices = [];
            $('.result-checkbox:checked').each(function() {
                selectedIndices.push($(this).closest('.result-card').data('index'));
            });

            if (selectedIndices.length === 0) {
                showToast('请至少选择一项数据', 'error');
                return;
            }

            const selectedItems = selectedIndices.map(i => currentResults[i]);
            const keyword = $('#keyword').val().trim();

            $.ajax({
                url: "{{ url_for('save_data') }}",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    items: selectedItems,
                    keyword: keyword
                }),
                success: function(response) {
                    showToast(response.message, 'success');
                    
                    // 处理成功的移除
                    if (response.successful_urls && response.successful_urls.length > 0) {
                        const successfulUrls = new Set(response.successful_urls);
                        let removedCount = 0;
                        
                        $('.result-card').each(function() {
                            const index = $(this).data('index');
                            const item = currentResults[index];
                            if (item && successfulUrls.has(item.url)) {
                                $(this).fadeOut(500, function() {
                                    $(this).remove();
                                });
                                removedCount++;
                            }
                        });
                        
                        // 更新头部可见计数
                        // 注意：我们不更新 currentResults 数组，以保持剩余项目的索引有效
                        const currentVisible = $('.result-card').length; // 如果立即运行，这可能会计算正在淡出的项目
                        // 最好依靠 removedCount
                        // 但由于 fadeOut 是异步的，我们可以只根据当前值更新文本
                        const countEl = $('#result-count');
                        const newCount = Math.max(0, parseInt(countEl.text()) - removedCount);
                        countEl.text(newCount);
                    }
                },
                error: function(xhr) {
                    showToast('保存失败: ' + (xhr.responseJSON?.error || '未知错误'), 'error');
                }
            });
        });
    });
</script>
{% endblock %}
