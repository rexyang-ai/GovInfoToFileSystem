{% extends "base.html" %}

{% block content %}
<div class="analysis-container" style="height: calc(100vh - 100px); display: flex; gap: 1.5rem;">
    <!-- Sidebar: Model Selection & History -->
    <div class="analysis-sidebar" style="width: 260px; display: flex; flex-direction: column; gap: 1rem; border-right: 1px solid var(--border-color); padding-right: 1rem;">
        <div class="sidebar-header">
            <h3>AI分析报告</h3>
            <p class="text-muted" style="font-size: 0.85rem;">基于深采数据智能分析</p>
            <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="createNewChat()" style="border: 1px solid var(--accent-color); color: var(--accent-color); background: transparent; padding: 0.4rem; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-plus"></i> 新建对话
            </button>
        </div>
        
        <div class="form-group">
            <label style="font-size: 0.9rem;">选择模型引擎</label>
            <select id="modelSelect" class="form-control">
                {% for model in models %}
                <option value="{{ model.id }}" data-provider="{{ model.provider }}">{{ model.name }}</option>
                {% else %}
                <option value="" disabled selected>请先配置AI模型</option>
                {% endfor %}
            </select>
        </div>

        <div class="history-list" id="historyList" style="flex: 1; overflow-y: auto;">
            <div class="text-muted" style="font-size: 0.85rem; text-align: center; margin-top: 2rem;">
                暂无历史会话
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="analysis-main" style="flex: 1; display: flex; flex-direction: column; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
        <!-- Chat Window -->
        <div id="chatWindow" style="flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- Welcome Message -->
            <div class="message ai">
                <div class="avatar" style="background: var(--accent-color);">AI</div>
                <div class="content-wrapper">
                    <div class="bubble">
                        你好！我是智能数据分析助手。我可以帮你查询数据库中的深采内容，进行统计、分析并生成报告。<br>
                        你可以试着问我：<br>
                        <ul>
                            <li>“统计一下最近采集了多少条数据？”</li>
                            <li>“帮我找出标题中包含‘政策’的内容。”</li>
                            <li>“分析一下最近采集数据的来源分布。”</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workflow Visualization (Status Bar) -->
        <div id="workflowStatus" style="padding: 0.5rem 1rem; background: rgba(var(--accent-rgb), 0.05); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); display: none; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--accent-color);">
            <div class="spinner-small"></div>
            <span id="statusText">正在思考...</span>
        </div>

        <!-- Input Area -->
        <div class="input-area" style="padding: 1.5rem; background: var(--bg-color);">
            <div class="input-group" style="position: relative;">
                <textarea id="queryInput" class="form-control" rows="3" placeholder="输入你的分析需求，例如：统计最近一周的数据采集情况..." style="resize: none; padding-right: 50px;"></textarea>
                <button id="sendBtn" class="btn-send" onclick="sendQuery()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="text-muted" style="font-size: 0.8rem; margin-top: 0.5rem; text-align: right;">
                按 Enter 发送，Shift + Enter 换行
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        display: flex;
        gap: 1rem;
        max-width: 85%;
        animation: fadeIn 0.3s ease;
    }
    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }
    .message.ai {
        align-self: flex-start;
    }
    .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        flex-shrink: 0;
    }
    .message.user .avatar {
        background: #666;
    }
    .bubble {
        padding: 1rem 1.2rem;
        border-radius: 12px;
        line-height: 1.6;
        position: relative;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
    }
    .message.user .bubble {
        background: var(--accent-color);
        color: white;
        border: none;
    }
    .message.ai .bubble {
        background: var(--card-bg);
    }
    
    /* Markdown & Table Styles in Bubble */
    .bubble table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 0.9rem;
    }
    .bubble th, .bubble td {
        border: 1px solid var(--border-color);
        padding: 0.5rem;
        text-align: left;
    }
    .bubble th {
        background: rgba(0,0,0,0.05);
    }
    .message.user .bubble table, 
    .message.user .bubble th, 
    .message.user .bubble td {
        border-color: rgba(255,255,255,0.2);
    }

    .btn-send {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: var(--accent-color);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }
    .btn-send:hover {
        transform: scale(1.1);
    }
    .btn-send:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .spinner-small {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(var(--accent-rgb), 0.3);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Tool Call Visualization */
    .tool-step {
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: rgba(0,0,0,0.02);
        border-radius: 6px;
    }
    .tool-step.active {
        color: var(--accent-color);
    }
    .tool-step i {
        width: 16px;
        text-align: center;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="{{ url_for('static', filename='js/libs/echarts/package/dist/echarts.min.js') }}"></script>
<script>
    const chatWindow = document.getElementById('chatWindow');
    const queryInput = document.getElementById('queryInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusDiv = document.getElementById('workflowStatus');
    const statusText = document.getElementById('statusText');
    
    let isProcessing = false;
    let currentConversationId = null;

    // Handle Enter key
    queryInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendQuery();
        }
    });

    // Load history on start
    document.addEventListener('DOMContentLoaded', function() {
        loadHistory();
    });

    function loadHistory() {
        fetch('/api/ai/conversations')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('historyList');
                if (data.length === 0) {
                    list.innerHTML = `
                        <div class="text-muted" style="font-size: 0.85rem; text-align: center; margin-top: 2rem;">
                            暂无历史会话
                        </div>`;
                    return;
                }
                
                list.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.style.cssText = 'padding: 0.8rem; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;';
                    if (item.id === currentConversationId) {
                        div.style.background = 'rgba(var(--accent-rgb), 0.1)';
                    }
                    
                    div.innerHTML = `
                        <div onclick="loadConversation(${item.id})" style="flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                            ${item.title}
                            <div style="font-size: 0.7rem; color: #999;">${item.created_at}</div>
                        </div>
                        <button onclick="deleteConversation(event, ${item.id})" style="border:none; background:none; color:#dc3545; cursor:pointer; padding:2px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    list.appendChild(div);
                });
            });
    }

    function createNewChat() {
        currentConversationId = null;
        chatWindow.innerHTML = `
            <div class="message ai">
                <div class="avatar" style="background: var(--accent-color);">AI</div>
                <div class="content-wrapper">
                    <div class="bubble">
                        你好！我是智能数据分析助手。我可以帮你查询数据库中的深采内容，进行统计、分析并生成报告。<br>
                        你可以试着问我：<br>
                        <ul>
                            <li>“统计一下最近采集了多少条数据？”</li>
                            <li>“帮我找出标题中包含‘政策’的内容。”</li>
                            <li>“分析一下最近采集数据的来源分布。”</li>
                        </ul>
                    </div>
                </div>
            </div>`;
        loadHistory(); // Refresh to clear active state
    }

    function loadConversation(id) {
        currentConversationId = id;
        loadHistory(); // Update active state
        
        fetch(`/api/ai/conversations/${id}/messages`)
            .then(res => res.json())
            .then(messages => {
                chatWindow.innerHTML = ''; // Clear existing
                
                if (messages.length === 0) {
                     chatWindow.innerHTML = `
                        <div class="message ai">
                            <div class="avatar" style="background: var(--accent-color);">AI</div>
                            <div class="content-wrapper">
                                <div class="bubble">
                                    对话已加载，请继续提问。
                                </div>
                            </div>
                        </div>`;
                }
                
                messages.forEach(msg => {
                    const bubble = appendMessage(msg.role, '', true);
                    
                    // Content
                    let contentDiv = document.createElement('div');
                    contentDiv.className = 'markdown-content';
                    contentDiv.innerHTML = marked.parse(msg.content || '');
                    bubble.appendChild(contentDiv);
                    
                    // Charts (meta_info)
                    if (msg.meta_info) {
                        try {
                            const meta = JSON.parse(msg.meta_info);
                            if (meta.chart_options) {
                                 const chartId = 'chart-' + Date.now() + Math.random();
                                 const container = document.createElement('div');
                                 container.className = 'chart-container';
                                 container.style.cssText = 'margin-top: 1rem; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fff;';
                                 
                                 const chartDiv = document.createElement('div');
                                 chartDiv.id = chartId;
                                 chartDiv.style.width = '100%';
                                 chartDiv.style.height = '400px';
                                 
                                 container.appendChild(chartDiv);
                                 bubble.appendChild(container);
                                 
                                 // Delay render slightly to ensure DOM is ready
                                 setTimeout(() => renderChart(chartDiv, meta.chart_options), 100);
                            }
                        } catch(e) { console.error(e); }
                    }
                });
                scrollToBottom();
            });
    }

    function deleteConversation(e, id) {
        e.stopPropagation();
        if(!confirm('确定要删除这个会话吗？')) return;
        
        fetch(`/api/ai/conversations/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    if(currentConversationId === id) createNewChat();
                    else loadHistory();
                }
            });
    }

    function scrollToBottom() {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendMessage(role, content, isHtml = false) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerText = role === 'user' ? 'U' : 'AI';
        
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'content-wrapper';
        contentWrapper.style.width = '100%';
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        if (isHtml) {
            bubble.innerHTML = content;
        } else {
            bubble.textContent = content;
        }
        
        contentWrapper.appendChild(bubble);
        div.appendChild(avatar);
        div.appendChild(contentWrapper);
        chatWindow.appendChild(div);
        scrollToBottom();
        
        return bubble; // Return for updating
    }

    function appendToolStep(container, text, icon = 'fas fa-cog') {
        let stepsContainer = container.querySelector('.steps-container');
        if (!stepsContainer) {
            stepsContainer = document.createElement('div');
            stepsContainer.className = 'steps-container';
            stepsContainer.style.marginBottom = '0.5rem';
            container.insertBefore(stepsContainer, container.firstChild);
        }

        const step = document.createElement('div');
        step.className = 'tool-step active';
        step.innerHTML = `<i class="${icon} fa-spin"></i> <span>${text}</span>`;
        stepsContainer.appendChild(step);
        return step;
    }

    function updateToolStep(stepElement, text, success = true) {
        const icon = stepElement.querySelector('i');
        icon.classList.remove('fa-spin');
        icon.className = success ? 'fas fa-check-circle' : 'fas fa-times-circle';
        icon.style.color = success ? '#28a745' : '#dc3545';
        stepElement.querySelector('span').innerText = text;
        stepElement.classList.remove('active');
    }

    async function sendQuery() {
        const text = queryInput.value.trim();
        const modelId = document.getElementById('modelSelect').value;
        
        if (!text || isProcessing) return;
        if (!modelId) {
            alert('请先选择一个AI模型');
            return;
        }

        // Ensure conversation exists
        if (!currentConversationId) {
            try {
                const res = await fetch('/api/ai/conversations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        title: text.length > 20 ? text.substring(0, 20) + '...' : text,
                        model_id: modelId
                    })
                });
                const data = await res.json();
                currentConversationId = data.id;
                loadHistory(); // Show in sidebar
            } catch (e) {
                console.error("Failed to create conversation:", e);
                alert("创建会话失败");
                return;
            }
        }

        // UI Updates
        queryInput.value = '';
        queryInput.disabled = true;
        sendBtn.disabled = true;
        isProcessing = true;
        
        appendMessage('user', text);
        
        // Prepare AI response placeholder
        const aiBubble = appendMessage('ai', '<span class="cursor">_</span>', true);
        
        // Show global status
        statusDiv.style.display = 'flex';
        statusText.innerText = '正在初始化...';

        // SSE Connection
        const eventSource = new EventSource(`/ai_analysis/chat_stream?model_id=${modelId}&message=${encodeURIComponent(text)}&conversation_id=${currentConversationId}`);
        
        let fullContent = '';
        let currentStepElement = null;

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'status') {
                // Workflow visualization
                statusText.innerText = data.message;
                if (currentStepElement) {
                    updateToolStep(currentStepElement, currentStepElement.querySelector('span').innerText + ' [完成]');
                }
                currentStepElement = appendToolStep(aiBubble, data.message);
            }
            else if (data.type === 'step') {
                if (data.status === 'running') {
                    currentStepElement = appendToolStep(aiBubble, data.name + ': ' + (data.details || ''));
                } else if (data.status === 'completed') {
                    if (currentStepElement) {
                        updateToolStep(currentStepElement, data.name + ': ' + (data.details || '完成'), true);
                        currentStepElement = null;
                    }
                }
            }
            else if (data.type === 'chart') {
                // Create chart container
                const chartId = 'chart-' + Date.now();
                const container = document.createElement('div');
                container.className = 'chart-container';
                container.style.marginTop = '1rem';
                container.style.marginBottom = '1rem';
                container.style.border = '1px solid #eee';
                container.style.borderRadius = '8px';
                container.style.padding = '10px';
                container.style.background = '#fff';
                
                const chartDiv = document.createElement('div');
                chartDiv.id = chartId;
                chartDiv.style.width = '100%';
                chartDiv.style.height = '400px';
                
                container.appendChild(chartDiv);
                aiBubble.appendChild(container);
                
                // Render chart
                renderChart(chartDiv, data.options);
                scrollToBottom();
            }
            else if (data.type === 'content') {
                fullContent += data.content;
                // Keep the steps at top, update content part
                // We need to separate steps and content in the bubble
                let contentDiv = aiBubble.querySelector('.markdown-content');
                if (!contentDiv) {
                    contentDiv = document.createElement('div');
                    contentDiv.className = 'markdown-content';
                    aiBubble.appendChild(contentDiv);
                }
                contentDiv.innerHTML = marked.parse(fullContent);
                scrollToBottom();
            }
            else if (data.type === 'error') {
                if (currentStepElement) updateToolStep(currentStepElement, '发生错误', false);
                let contentDiv = aiBubble.querySelector('.markdown-content');
                if (!contentDiv) {
                    contentDiv = document.createElement('div');
                    contentDiv.className = 'markdown-content';
                    aiBubble.appendChild(contentDiv);
                }
                contentDiv.innerHTML += `<br><span style="color:red">Error: ${data.content}</span>`;
                closeStream();
            }
            else if (data.type === 'done') {
                if (currentStepElement) updateToolStep(currentStepElement, '完成', true);
                closeStream();
            }
        };

        eventSource.onerror = function() {
            closeStream();
            if (!fullContent) {
                // Check if it was just a normal close
            }
        };

        function closeStream() {
            eventSource.close();
            isProcessing = false;
            queryInput.disabled = false;
            sendBtn.disabled = false;
            statusDiv.style.display = 'none';
            queryInput.focus();
            
            // Remove cursor
            const cursor = aiBubble.querySelector('.cursor');
            if (cursor) cursor.remove();
        }
    }

    function renderChart(container, options) {
        const chart = echarts.init(container);
        
        let echartOption = {
            title: {
                text: options.title,
                left: 'center'
            },
            tooltip: {
                trigger: 'item'
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                bottom: 0
            },
            series: []
        };
        
        if (options.chart_type === 'pie') {
            echartOption.series = [{
                name: options.series_name || 'Access From',
                type: 'pie',
                radius: '50%',
                data: options.x_data.map((label, index) => ({
                    value: options.series_data[index],
                    name: label
                })),
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }];
        } else {
            // Bar or Line
            echartOption.xAxis = {
                type: 'category',
                data: options.x_data
            };
            echartOption.yAxis = {
                type: 'value'
            };
            echartOption.series = [{
                name: options.series_name,
                data: options.series_data,
                type: options.chart_type
            }];
            
            // Add tooltip trigger axis for better UX on bar/line
            echartOption.tooltip.trigger = 'axis';
        }
        
        chart.setOption(echartOption);
        
        // Resize handler
        window.addEventListener('resize', function() {
            chart.resize();
        });
    }
</script>
{% endblock %}