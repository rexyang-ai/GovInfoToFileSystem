{% extends "base.html" %}

{% block content %}
<div>
    <h2>数据仓库</h2>
    <p class="text-muted">管理和查看已保存的历史数据</p>
    
    <div class="filter-bar">
        <form method="GET" action="{{ url_for('warehouse') }}" style="display: flex; gap: 1rem; width: 100%; align-items: flex-end;">
            <div class="filter-group" style="flex: 1;">
                <label class="form-label">关键字检索</label>
                <input type="text" name="keyword" class="form-control" value="{{ request.args.get('keyword', '') }}" placeholder="标题/摘要/搜索词...">
            </div>
            <div class="filter-group" style="width: 200px;">
                <label class="form-label">按日期归类</label>
                <input type="date" name="date" class="form-control" value="{{ request.args.get('date', '') }}">
            </div>
            <button type="submit" class="btn">筛选</button>
            <a href="{{ url_for('warehouse') }}" class="btn btn-secondary">重置</a>
        </form>
    </div>

    <div style="margin-bottom: 1rem;">
        <button class="btn btn-success" onclick="startBatchCrawl()">批量深度采集</button>
    </div>

    <div class="table-container">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                    <th style="width: 40px;">ID</th>
                    <th style="width: 120px;">采集时间</th>
                    <th style="width: 120px;">搜索词</th>
                    <th style="width: 250px;">标题</th>
                    <th style="width: 150px;">采集和嗅探规则</th>
                    <th style="width: 200px;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td><input type="checkbox" class="item-checkbox" value="{{ item.id }}"></td>
                    <td>{{ item.id }}</td>
                    <td>{{ item.created_at }}</td>
                    <td>{{ item.search_keyword }}</td>
                    <td>
                        <a href="{{ item.url }}" target="_blank" style="color: var(--accent-color); text-decoration: none;">
                            {{ item.title }}
                        </a>
                        <div class="badge badge-light" style="margin-top: 4px;">
                            {{ item.url | get_domain }}
                        </div>
                    </td>
                    <td style="font-size: 0.9rem; color: var(--secondary-color); text-align: center;">
                        {% if item.rule_name %}
                        <span class="text-success" style="font-weight: bold;">✔ {{ item.rule_name }}</span>
                        {% else %}
                        <span class="text-muted">暂无规则</span>
                        {% endif %}
                    </td>
                    <td style="white-space: nowrap;">
                        <a href="{{ item.url }}" target="_blank" class="btn btn-sm">查看</a>
                        <button class="btn btn-sm btn-success" style="margin-left: 4px;" data-id="{{ item.id }}" onclick="startDeepCrawl(this.dataset.id)">采集</button>
                        <button class="btn btn-sm btn-info" style="margin-left: 4px;" data-url="{{ item.url }}" onclick="startSniff(this.dataset.url)">嗅探</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center" style="padding: 2rem;">暂无数据</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('warehouse', page=page-1, keyword=request.args.get('keyword', ''), date=request.args.get('date', '')) }}" class="pagination-btn">上一页</a>
        {% else %}
        <span class="pagination-btn disabled">上一页</span>
        {% endif %}
        
        <span class="pagination-info">第 {{ page }} / {{ total_pages }} 页</span>
        
        {% if page < total_pages %}
        <a href="{{ url_for('warehouse', page=page+1, keyword=request.args.get('keyword', ''), date=request.args.get('date', '')) }}" class="pagination-btn">下一页</a>
        {% else %}
        <span class="pagination-btn disabled">下一页</span>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="crawlModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 style="margin: 0;">深度采集任务</h3>
            <span class="close-modal-btn" onclick="closeCrawlModal()">&times;</span>
        </div>
        
        <div id="crawlProgress" style="padding: 20px 0;">
            <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                <span id="progressText">正在初始化...</span>
                <span id="progressCount">0/0</span>
            </div>
            <div style="background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden;">
                <div id="progressBar" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <div id="crawlLogs" class="crawl-logs">
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn" id="closeCrawlBtn" onclick="closeCrawlModal()" disabled>后台运行</button>
        </div>
    </div>
</div>

<div id="sniffModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle" style="margin: 0;">嗅探规则</h3>
            <span class="close-modal-btn" onclick="closeModal()">&times;</span>
        </div>
        
        <div id="sniffLoading" style="text-align: center; padding: 20px;">
            <div class="spinner"></div>
            <p>正在智能分析页面结构，请稍候...</p>
        </div>
        
        <div id="sniffForm" style="display: none;">
            <div class="form-group">
                <label>规则名称</label>
                <input type="text" id="ruleName" class="form-control">
            </div>
            <div class="form-group">
                <label>目标 URL</label>
                <input type="text" id="ruleUrl" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>标题 XPath</label>
                <input type="text" id="titleXpath" class="form-control">
            </div>
            <div class="form-group">
                <label>正文 XPath</label>
                <input type="text" id="contentXpath" class="form-control">
            </div>
            <div class="form-group">
                <label>请求头 (JSON)</label>
                <textarea id="reqHeaders" class="form-control" rows="3"></textarea>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal()">取消</button>
                <button class="btn" onclick="saveRule()">保存规则</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const modal = document.getElementById('sniffModal');
    const loadingDiv = document.getElementById('sniffLoading');
    const formDiv = document.getElementById('sniffForm');
    
    function closeModal() {
        modal.classList.remove('show');
    }
    
    function startSniff(url) {
        // Reset UI
        modal.classList.add('show');
        loadingDiv.style.display = 'block';
        formDiv.style.display = 'none';
        document.getElementById('modalTitle').innerText = '正在嗅探...';
        
        fetch("{{ url_for('sniff') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('嗅探失败: ' + data.error, 'error');
                closeModal();
            } else {
                // Show Form
                loadingDiv.style.display = 'none';
                formDiv.style.display = 'block';
                document.getElementById('modalTitle').innerText = '确认采集规则';
                
                // Fill data
                document.getElementById('ruleUrl').value = data.data.final_url || url;
                document.getElementById('ruleName').value = data.data.rule_name;
                document.getElementById('titleXpath').value = data.data.title_xpath;
                document.getElementById('contentXpath').value = data.data.content_xpath;
                document.getElementById('reqHeaders').value = data.data.request_headers;
            }
        })
        .catch(error => {
            showToast('请求错误: ' + error, 'error');
            closeModal();
        });
    }
    
    function saveRule() {
        const payload = {
            url: document.getElementById('ruleUrl').value,
            rule_name: document.getElementById('ruleName').value,
            title_xpath: document.getElementById('titleXpath').value,
            content_xpath: document.getElementById('contentXpath').value,
            request_headers: document.getElementById('reqHeaders').value
        };
        
        fetch("{{ url_for('save_rule') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('保存失败: ' + data.error, 'error');
            } else {
                showToast(data.message, 'success');
                closeModal();
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showToast('保存请求错误: ' + error, 'error');
        });
    }

    // --- Deep Crawl Logic ---
    const crawlModal = document.getElementById('crawlModal');
    const closeCrawlBtn = document.getElementById('closeCrawlBtn');
    const logsDiv = document.getElementById('crawlLogs');
    let pollInterval = null;
    let currentTaskId = null;

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
    }

    function startDeepCrawl(id) {
        startCrawl([id]);
    }

    function startBatchCrawl() {
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value);
        
        if (ids.length === 0) {
            showToast('请至少选择一项进行采集', 'warning');
            return;
        }
        
        startCrawl(ids);
    }

    function startCrawl(ids) {
        showConfirm(`确定要对选中的 ${ids.length} 条数据进行深度采集吗？`, function() {
            // Reset UI
            crawlModal.classList.add('show');
            logsDiv.innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').innerText = '正在初始化...';
            document.getElementById('progressCount').innerText = `0/${ids.length}`;
            closeCrawlBtn.innerText = '后台运行';
            closeCrawlBtn.disabled = false;

            fetch("{{ url_for('start_crawl') }}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids: ids })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    showToast('启动失败: ' + data.error, 'error');
                    crawlModal.classList.remove('show');
                } else {
                    currentTaskId = data.task_id;
                    pollStatus();
                }
            })
            .catch(err => {
                showToast('请求错误: ' + err, 'error');
                crawlModal.classList.remove('show');
            });
        });
    }

    function pollStatus() {
        if (!currentTaskId) return;

        pollInterval = setInterval(() => {
            fetch(`/crawl/status/${currentTaskId}`)
                .then(res => res.json())
                .then(task => {
                    // Update Progress
                    const percent = Math.floor((task.current / task.total) * 100);
                    document.getElementById('progressBar').style.width = `${percent}%`;
                    document.getElementById('progressCount').innerText = `${task.current}/${task.total}`;
                    document.getElementById('progressText').innerText = `正在采集... (成功: ${task.success}, 失败: ${task.failed})`;

                    // Update Logs
                    if (task.logs && task.logs.length > 0) {
                        logsDiv.innerHTML = task.logs.map(log => `<div>${log}</div>`).join('');
                        logsDiv.scrollTop = logsDiv.scrollHeight;
                    }

                    if (task.status === 'completed' || task.status === 'error') {
                        clearInterval(pollInterval);
                        document.getElementById('progressText').innerText = task.status === 'completed' ? '采集任务完成' : '采集任务异常';
                        closeCrawlBtn.innerText = '关闭';
                        closeCrawlBtn.disabled = false;
                        
                        // Show summary report
                        const summary = `
                            <div style="margin-top: 20px;padding: 10px;background: #78909C;border-left: 5px solid #607D8B;">
                                <strong>任务简报</strong><br>
                                总数: ${task.total}<br>
                                成功: ${task.success}<br>
                                失败: ${task.failed}
                            </div>
                        `;
                        logsDiv.innerHTML += summary;
                        logsDiv.scrollTop = logsDiv.scrollHeight;
                    }
                })
                .catch(err => {
                    console.error('Poll error:', err);
                });
        }, 1000);
    }

    function closeCrawlModal() {
        crawlModal.classList.remove('show');
        if (pollInterval) clearInterval(pollInterval);
    }
</script>
{% endblock %}

